<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PokeCatch 3D</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#B0E0E6">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png">

    <style>
        /* --- Core Layout --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #87CEEB;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #world-stage {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            /* 3D Perspective Container */
            perspective: 800px; 
            overflow: hidden;
        }

        /* --- Environment --- */
        .sky {
            position: absolute; top: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            z-index: 1;
        }
        .ground {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: linear-gradient(to bottom, #8BC34A 0%, #4CAF50 100%);
            z-index: 1;
        }
        .horizon-decoration {
            position: absolute; bottom: 40%; left: 0; width: 100%; height: 100px;
            pointer-events: none; z-index: 2;
        }

        /* --- Pokemon (Target) --- */
        #pokemon-wrapper {
            position: absolute;
            /* Positioned in '3D' space visually */
            top: 40%; /* Horizon line */
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px; height: 200px;
            z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }

        #pokemon-info-card {
            background: rgba(255, 255, 255, 0.85);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        #pokemon-sprite {
            width: 140px; height: 140px;
            object-fit: contain;
            filter: drop-shadow(0 15px 10px rgba(0,0,0,0.3));
            animation: idleFloat 3s infinite ease-in-out;
            transition: transform 0.2s, opacity 0.3s;
        }

        @keyframes idleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* --- Target Rings --- */
        #ring-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 140px; height: 140px;
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .ring {
            position: absolute;
            border-radius: 50%;
            box-sizing: border-box;
            border-width: 4px;
            border-style: solid;
        }
        #ring-outer { width: 100%; height: 100%; border-color: rgba(255,255,255,0.6); }
        #ring-inner {
            width: 100%; height: 100%;
            animation: shrinkRing 2s linear infinite;
        }
        @keyframes shrinkRing { 0% { transform: scale(1); } 100% { transform: scale(0); } }

        /* --- The Ball (Player Object) --- */
        #ball-container {
            position: absolute;
            width: 60px; height: 60px;
            left: 50%; bottom: 20%; /* Starting Rest Position */
            transform: translate(-50%, 0);
            z-index: 100;
            pointer-events: none; /* Input handled globally */
            will-change: transform, top, left;
        }
        
        #pokeball-img {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: contain; background-repeat: no-repeat;
            border-radius: 50%;
        }

        /* Shadow to help depth perception */
        #ball-shadow {
            position: absolute;
            width: 50px; height: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            bottom: -10px; left: 50%;
            transform: translateX(-50%);
            z-index: -1;
            transition: opacity 0.2s;
        }

        /* --- UI Overlay --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 200;
        }

        .hud-btn {
            position: absolute; bottom: 20px;
            background: white; padding: 10px 16px; border-radius: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            pointer-events: auto; display: flex; align-items: center; gap: 8px;
            font-weight: bold; font-size: 14px; cursor: pointer;
        }
        #btn-berry { left: 20px; }
        #btn-ball { right: 20px; }
        
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s ease-out;
            pointer-events: auto; box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            z-index: 300; display: flex; flex-direction: column; gap: 10px;
        }
        .bottom-sheet.open { transform: translateY(0); }
        .item-row { display: flex; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .item-row:active { background: #eee; }

        #message-toast {
            position: absolute; top: 30%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 8px 16px; border-radius: 20px;
            font-weight: bold; font-size: 18px;
            opacity: 0; transition: opacity 0.3s;
        }

        #result-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 400;
        }
        .btn-primary {
            background: #4CAF50; color: white; border: none; padding: 14px 40px;
            font-size: 18px; border-radius: 30px; margin-top: 30px; font-weight: bold;
        }

        #active-berry-indicator {
            position: absolute; top: -40px; left: 50%;
            transform: translateX(-50%); width: 40px; display: none;
        }

        /* Animations */
        .shake-anim { animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-5deg); }
            20%, 80% { transform: translate3d(2px, 0, 0) rotate(5deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-5deg); }
            40%, 60% { transform: translate3d(4px, 0, 0) rotate(5deg); }
        }

    </style>
    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    </script>
</head>
<body>

<div id="world-stage">
    <div class="sky"></div>
    <div class="ground"></div>
    <!-- Simple Decorations -->
    <div class="horizon-decoration">
        <div style="position:absolute; left: -20px; bottom: 0; width: 80px; height: 100px; background:#2E7D32; border-radius: 50% 50% 0 0;"></div>
        <div style="position:absolute; right: -20px; bottom: 0; width: 100px; height: 120px; background:#D84315; border-radius: 50% 50% 0 0;"></div>
    </div>

    <!-- The Target (Pokemon) -->
    <div id="pokemon-wrapper">
        <div id="pokemon-info-card">Loading...</div>
        <div style="position: relative;">
            <img id="active-berry-indicator" src="" />
            <img id="pokemon-sprite" src="" />
            <div id="ring-container">
                <div id="ring-outer" class="ring"></div>
                <div id="ring-inner" class="ring"></div>
            </div>
        </div>
    </div>

    <!-- The Physics Object (Ball) -->
    <div id="ball-container">
        <div id="pokeball-img"></div>
        <div id="ball-shadow"></div>
    </div>
</div>

<div id="ui-layer">
    <div id="message-toast">Excellent!</div>

    <div id="btn-berry" class="hud-btn" onclick="ui.openMenu('berry')">
        <img style="width:24px" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23D84315'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/></svg>">
        Berries
    </div>
    <div id="btn-ball" class="hud-btn" onclick="ui.openMenu('ball')">
        <img id="current-ball-icon" style="width:24px" src="">
        Balls
    </div>

    <div id="menu-berry" class="bottom-sheet">
        <div style="text-align:center; font-weight:bold; color:#666">SELECT BERRY</div>
        <div id="berry-list-container"></div>
        <button onclick="ui.closeMenus()" style="padding:12px; border-radius:8px; border:1px solid #ddd; background:white;">Close</button>
    </div>

    <div id="menu-ball" class="bottom-sheet">
        <div style="text-align:center; font-weight:bold; color:#666">SELECT BALL</div>
        <div id="ball-list-container"></div>
        <button onclick="ui.closeMenus()" style="padding:12px; border-radius:8px; border:1px solid #ddd; background:white;">Close</button>
    </div>

    <div id="result-modal">
        <h1 id="result-title" style="font-size: 36px; color:#4CAF50; margin-bottom:10px;">Gotcha!</h1>
        <div id="result-content" style="width:80%; font-size:18px;"></div>
        <button class="btn-primary" onclick="game.reset()">Next Pok√©mon</button>
    </div>
</div>

<script>
    /* ================= GAME DATA ================= */
    const ASSETS = {
        poke: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/",
        item: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/"
    };

    const INVENTORY = {
        balls: {
            'Poke Ball': { img: 'poke-ball.png', rate: 0.0, qty: 20 },
            'Great Ball': { img: 'great-ball.png', rate: 0.15, qty: 10 },
            'Ultra Ball': { img: 'ultra-ball.png', rate: 0.3, qty: 5 },
            'Master Ball': { img: 'master-ball.png', rate: 100, qty: 1 }
        },
        berries: {
            'Razz Berry': { img: 'razz-berry.png', mod: 0.2, qty: 5 },
            'Nanab Berry': { img: 'nanab-berry.png', mod: 0.0, qty: 5 },
            'Pinap Berry': { img: 'pinap-berry.png', mod: 0.0, qty: 5 }
        }
    };

    const POKEDEX = [
        {id:25, name:"Pikachu"}, {id:1, name:"Bulbasaur"}, {id:4, name:"Charmander"},
        {id:7, name:"Squirtle"}, {id:133, name:"Eevee"}, {id:150, name:"Mewtwo"},
        {id:143, name:"Snorlax"}, {id:94, name:"Gengar"}, {id:384, name:"Rayquaza"}
    ];

    /* ================= PHYSICS ENGINE ================= */
    const PHYSICS = {
        gravity: 0.002, // Drag down
        throwThreshold: -1.2, // Min velocityY to count as a throw
        depthTarget: 100, // The Z-depth where the pokemon exists
        friction: 0.98
    };

    /* ================= APP CONTROLLER ================= */
    const app = {
        state: {
            pokemon: null,
            ball: 'Poke Ball',
            berry: null,
            phase: 'idle', // idle, holding, flying, catching, result
            xp: 0,
            candy: 0
        },
        
        init: () => {
            ui.updateInventory();
            game.spawn();
            
            // Global Input Listeners (The "Rick Solo" Catch-All)
            const stage = document.getElementById('world-stage');
            stage.addEventListener('touchstart', input.start, {passive: false});
            stage.addEventListener('touchmove', input.move, {passive: false});
            stage.addEventListener('touchend', input.end, {passive: false});
            
            // Mouse fallbacks
            stage.addEventListener('mousedown', input.start);
            window.addEventListener('mousemove', input.move);
            window.addEventListener('mouseup', input.end);
        }
    };

    /* ================= INPUT HANDLER ================= */
    const input = {
        data: { active: false, startX:0, startY:0, lastX:0, lastY:0, history:[] },

        start: (e) => {
            if (app.state.phase !== 'idle') return;
            const pt = e.touches ? e.touches[0] : e;
            const rect = document.body.getBoundingClientRect();
            
            // Interaction Area: Bottom 50% of screen
            if (pt.clientY < rect.height * 0.5) return;

            e.preventDefault();
            input.data.active = true;
            input.data.startX = pt.clientX;
            input.data.startY = pt.clientY;
            input.data.lastX = pt.clientX;
            input.data.lastY = pt.clientY;
            input.data.history = [];
            
            app.state.phase = 'holding';
            
            // Visual Snap
            ball.updateVisual(pt.clientX, pt.clientY, 1, 0);
            document.getElementById('ball-container').style.transition = 'transform 0.1s';
            ball.scale = 1.2; 
        },

        move: (e) => {
            if (!input.data.active) return;
            e.preventDefault(); // Stop scrolling
            const pt = e.touches ? e.touches[0] : e;
            
            // Physics History for Velocity
            const now = Date.now();
            input.data.history.push({x: pt.clientX, y: pt.clientY, t: now});
            if (input.data.history.length > 6) input.data.history.shift();

            // Curve Logic (Spin)
            const deltaX = pt.clientX - input.data.lastX;
            ball.rotation += deltaX * 1.5;

            input.data.lastX = pt.clientX;
            input.data.lastY = pt.clientY;

            // Visual Follow
            ball.updateVisual(pt.clientX, pt.clientY, 1.2, ball.rotation);
        },

        end: (e) => {
            if (!input.data.active) return;
            input.data.active = false;
            
            // Calculate Vector
            const hist = input.data.history;
            if (hist.length < 2) { game.resetBall(); return; }
            
            const start = hist[0];
            const end = hist[hist.length-1];
            const dt = end.t - start.t;
            
            // Anti-Cheese: If user held too long, drop it
            if (Date.now() - end.t > 150) { game.resetBall(); return; }

            const vx = (end.x - start.x) / dt;
            const vy = (end.y - start.y) / dt; // Negative is UP

            // Anti-Cheese: Minimum Speed Check
            if (vy > -0.8) { 
                // Too slow, just drop
                game.dropBall(); 
            } else {
                // Valid Throw
                game.throwBall(vx, vy);
            }
        }
    };

    /* ================= BALL OBJECT ================= */
    const ball = {
        el: document.getElementById('ball-container'),
        shadow: document.getElementById('ball-shadow'),
        x: 0, y: 0, z: 0,
        vx: 0, vy: 0, vz: 0,
        rotation: 0, scale: 1,

        updateVisual: (screenX, screenY, scale, rot) => {
            // Apply 2D screen coordinates directly during 'holding'
            ball.el.style.left = screenX + 'px';
            ball.style.top = screenY + 'px'; // Using .style directly on obj for logic, el for DOM
            ball.el.style.top = screenY + 'px';
            ball.el.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${rot}deg)`;
            
            // Shadow logic
            ball.shadow.style.opacity = scale > 1 ? 1 : 1 - (1-scale);
        }
    };

    /* ================= GAME LOGIC ================= */
    const game = {
        spawn: () => {
            const p = POKEDEX[Math.floor(Math.random() * POKEDEX.length)];
            const cp = Math.floor(Math.random() * 2500) + 100;
            app.state.pokemon = { ...p, cp: cp };
            app.state.phase = 'idle';
            app.state.activeBerry = null;

            // DOM Updates
            document.getElementById('pokemon-sprite').src = ASSETS.poke + p.id + '.png';
            document.getElementById('pokemon-sprite').style.opacity = 1;
            document.getElementById('pokemon-sprite').style.transform = 'scale(1)';
            document.getElementById('pokemon-info-card').textContent = `${p.name} CP ${cp}`;
            
            // Ring Color
            const diff = Math.random();
            const color = diff > 0.6 ? '#FF0000' : (diff > 0.3 ? '#FFA500' : '#4CAF50');
            document.getElementById('ring-inner').style.borderColor = color;
            document.getElementById('ring-container').style.display = 'flex';
            document.getElementById('active-berry-indicator').style.display = 'none';

            game.resetBall();
        },

        resetBall: () => {
            app.state.phase = 'idle';
            ball.el.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            ball.el.style.left = '50%';
            ball.el.style.top = '85%'; // Rest position
            ball.el.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)';
            ball.rotation = 0;
            ball.shadow.style.opacity = 1;
            ball.el.style.display = 'block';
        },

        dropBall: () => {
            // Anti-cheese fail animation
            ball.el.style.transition = 'top 0.5s ease-in';
            ball.el.style.top = '100%';
            ui.toast("Throw harder!");
            setTimeout(game.resetBall, 600);
        },

        throwBall: (vx, vy) => {
            // Check Inventory
            if (INVENTORY.balls[app.state.ball].qty <= 0) {
                ui.toast("Out of balls!");
                game.resetBall();
                return;
            }
            INVENTORY.balls[app.state.ball].qty--;
            ui.updateInventory();

            app.state.phase = 'flying';
            ball.el.style.transition = 'none'; // Physics Mode

            // Convert 2D input to 3D Physics vectors
            // velocity Y (screen up) becomes velocity Z (depth)
            // velocity X (screen side) remains velocity X
            // We need a new velocity Y for gravity arc (Kick up)
            
            let throwPower = Math.abs(vy); // 0.8 to 3.0 usually
            
            ball.x = input.data.lastX;
            ball.y = input.data.lastY;
            ball.z = 0;

            ball.vx = vx * 15; // Sideways speed
            ball.vz = throwPower * 3.5; // Depth speed (Forward)
            ball.vy = -18; // Initial Upward kick (Arc)
            
            // Curve factor
            let curve = (ball.rotation / 50) * 0.5;

            game.loop();
        },

        loop: () => {
            if (app.state.phase !== 'flying') return;

            // Physics Steps
            ball.z += ball.vz;
            ball.x += ball.vx;
            ball.y += ball.vy;

            // Curve Logic
            ball.vx -= (ball.rotation * 0.005); // Spin affects X

            // Gravity
            ball.vy += 0.9; 

            // Air Resistance
            ball.vz *= 0.99;

            // Visual Rendering
            // Perspective Projection: x = x / z depth factor
            // Simple approach: Scale based on Z, move Y up based on Z (horizon)
            
            const maxZ = 120; // Distance to pokemon
            const progress = ball.z / maxZ; // 0 to 1
            
            // Scale Calculation (Pseudo-3D)
            let scale = 1 - (progress * 0.7); // Ends at 0.3 scale
            if (scale < 0.2) scale = 0.2;

            ball.el.style.left = ball.x + 'px';
            ball.el.style.top = ball.y + 'px';
            ball.el.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${ball.rotation += 15}deg)`;
            ball.shadow.style.opacity = 1 - progress;

            // Collision Check
            if (ball.z >= PHYSICS.depthTarget) {
                // We reached the depth plane of the Pokemon
                game.checkCollision(scale);
                return; // Stop loop
            }

            // Miss Check (Ground or Sky)
            if (ball.y > window.innerHeight || ball.y < -100) {
                ui.toast("Miss!");
                setTimeout(game.resetBall, 800);
                return;
            }

            requestAnimationFrame(game.loop);
        },

        checkCollision: (scale) => {
            // Get Pokemon Screen Rect
            const pokeEl = document.getElementById('pokemon-wrapper');
            const rect = pokeEl.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;

            // Distance Check (Circle vs Circle basically)
            const dist = Math.sqrt(Math.pow(ball.x - centerX, 2) + Math.pow(ball.y - centerY, 2));
            const hitRadius = 70; // Generous hit box

            if (dist < hitRadius) {
                // HIT!
                app.state.phase = 'catching';
                
                // Ring Size Calculation
                const inner = document.getElementById('ring-inner').offsetWidth;
                const outer = document.getElementById('ring-outer').offsetWidth;
                const accuracy = inner/outer;
                
                let bonus = 1;
                let msg = "";
                if (accuracy < 0.2) { msg = "Excellent!"; bonus = 1.85; }
                else if (accuracy < 0.5) { msg = "Great!"; bonus = 1.5; }
                else if (accuracy < 0.9) { msg = "Nice!"; bonus = 1.15; }
                if (msg) ui.toast(msg);

                // Snap Animation
                ball.el.style.transition = 'all 0.1s';
                ball.el.style.left = centerX + 'px';
                ball.el.style.top = centerY + 'px';
                ball.el.style.transform = `translate(-50%, -50%) scale(0.6)`;
                
                // Hide UI
                document.getElementById('ring-container').style.display = 'none';
                
                // Suck Animation
                setTimeout(() => {
                    const sprite = document.getElementById('pokemon-sprite');
                    sprite.style.transform = 'scale(0) rotate(180deg)';
                    sprite.style.opacity = 0;
                    
                    // Ball drops to ground
                    setTimeout(() => {
                        ball.el.style.transition = 'top 0.4s ease-in';
                        ball.el.style.top = (centerY + 100) + 'px'; // Drop
                        game.startShake(bonus);
                    }, 400);
                }, 100);

            } else {
                // Missed (Too far left/right/high/low) but correct depth
                ui.toast("Miss!");
                ball.el.style.transition = 'top 0.5s ease-in';
                ball.el.style.top = (window.innerHeight + 100) + 'px'; // Fall off screen
                setTimeout(game.resetBall, 800);
            }
        },

        startShake: (bonus) => {
            let shakes = 0;
            const maxShakes = 3;
            
            // Calculate Catch Chance
            let baseRate = 0.4;
            baseRate += INVENTORY.balls[app.state.ball].rate;
            if (app.state.activeBerry) baseRate += INVENTORY.berries[app.state.activeBerry].mod;
            baseRate *= bonus;
            
            if (app.state.ball === 'Master Ball') baseRate = 100;

            function doShake() {
                if (shakes === maxShakes) {
                    game.captureSuccess(bonus);
                    return;
                }
                
                // Check roll
                if (Math.random() < baseRate) {
                    shakes++;
                    ball.el.style.animation = 'none';
                    ball.el.offsetHeight; 
                    ball.el.style.animation = 'shake 0.8s';
                    setTimeout(doShake, 1100);
                } else {
                    game.breakFree();
                }
            }
            setTimeout(doShake, 500);
        },

        breakFree: () => {
            ui.toast("Broke free!");
            ball.el.style.display = 'none';
            
            const sprite = document.getElementById('pokemon-sprite');
            sprite.style.transform = 'scale(1)';
            sprite.style.opacity = 1;
            
            document.getElementById('ring-container').style.display = 'flex';
            app.state.activeBerry = null;
            document.getElementById('active-berry-indicator').style.display = 'none';
            
            setTimeout(game.resetBall, 1500);
        },

        captureSuccess: (bonus) => {
            ball.el.classList.add('catch-success'); // Darken ball
            
            let xp = Math.floor(100 * bonus);
            let candy = app.state.activeBerry === 'Pinap Berry' ? 6 : 3;
            
            app.state.xp += xp;
            app.state.candy += candy;

            const modal = document.getElementById('result-modal');
            modal.style.display = 'flex';
            document.getElementById('result-content').innerHTML = `
                <div style="display:flex; justify-content:space-between; margin:5px 0;"><span>XP</span> <b>+${xp}</b></div>
                <div style="display:flex; justify-content:space-between; margin:5px 0;"><span>Earned:</span></div>
                <div style="display:flex; justify-content:space-between; margin:5px 0; color:#E91E63"><span>Candy:</span> <b>+${candy}</b></div>
                <div style="display:flex; justify-content:space-between; margin:5px 0; color:#9C27B0"><span>Stardust:</span> <b>+100</b></div>
            `;
        },

        reset: () => {
            document.getElementById('result-modal').style.display = 'none';
            ball.el.classList.remove('catch-success');
            game.spawn();
        }
    };

    /* ================= UI CONTROLLER ================= */
    const ui = {
        toast: (msg) => {
            const el = document.getElementById('message-toast');
            el.innerText = msg;
            el.style.opacity = 1;
            el.style.top = "25%";
            setTimeout(() => { el.style.opacity = 0; el.style.top = "30%"; }, 1500);
        },

        openMenu: (type) => {
            if (app.state.phase !== 'idle') return;
            document.getElementById('menu-' + type).classList.add('open');
            const container = document.getElementById(type + '-list-container');
            container.innerHTML = '';
            
            const list = INVENTORY[type === 'ball' ? 'balls' : 'berries'];
            
            for (let [key, val] of Object.entries(list)) {
                let row = document.createElement('div');
                row.className = 'item-row';
                row.onclick = () => ui.selectItem(type, key);
                row.innerHTML = `
                    <img src="${ASSETS.item + val.img}" style="width:40px; margin-right:15px">
                    <div style="flex:1">
                        <div style="font-weight:bold">${key}</div>
                        <div style="font-size:12px; color:#888">x${val.qty}</div>
                    </div>
                `;
                if (val.qty < 1) row.style.opacity = 0.5;
                container.appendChild(row);
            }
        },

        closeMenus: () => {
            document.querySelectorAll('.bottom-sheet').forEach(el => el.classList.remove('open'));
        },

        selectItem: (type, key) => {
            const item = INVENTORY[type === 'ball' ? 'balls' : 'berries'][key];
            if (item.qty <= 0) return;

            if (type === 'ball') {
                app.state.ball = key;
            } else {
                if (app.state.activeBerry) { ui.toast("Berry already active"); return; }
                INVENTORY.berries[key].qty--;
                app.state.activeBerry = key;
                document.getElementById('active-berry-indicator').src = ASSETS.item + item.img;
                document.getElementById('active-berry-indicator').style.display = 'block';
                ui.toast(key + " used!");
            }
            ui.updateInventory();
            ui.closeMenus();
        },

        updateInventory: () => {
            const b = INVENTORY.balls[app.state.ball];
            document.getElementById('current-ball-icon').src = ASSETS.item + b.img;
            document.getElementById('pokeball-img').style.backgroundImage = `url('${ASSETS.item + b.img}')`;
        }
    };

    // START
    window.onload = app.init;

</script>
</body>
</html>