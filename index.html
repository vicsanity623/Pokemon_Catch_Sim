<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PokeCatch Pro - Spin Update</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#87CEEB">

    <style>
        /* Base Reset */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #87CEEB;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            perspective: 700px; /* Depth perception */
            background: linear-gradient(to bottom, #4FC3F7 0%, #E1F5FE 60%, #81C784 60%, #43A047 100%);
        }

        /* Scenery */
        .hill { position: absolute; bottom: 40%; width: 300px; height: 150px; border-radius: 50% 50% 0 0; z-index: 1; pointer-events: none; }
        
        /* Target (Pokemon) */
        #pokemon-wrap {
            position: absolute; top: 45%; left: 50%;
            transform: translate3d(-50%, -50%, -100px);
            width: 250px; height: 250px; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            pointer-events: none;
        }
        #poke-sprite {
            width: 180px; height: 180px; object-fit: contain;
            filter: drop-shadow(0 15px 10px rgba(0,0,0,0.2));
            animation: breathe 3s infinite ease-in-out;
            transition: opacity 0.2s, transform 0.2s;
        }
        @keyframes breathe { 50% { transform: scale(1.05); } }

        /* Rings */
        #ring-sys {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 140px; height: 140px; display: flex; justify-content: center; align-items: center;
        }
        .ring { position: absolute; border-radius: 50%; box-sizing: border-box; }
        #r-out { width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.7); }
        #r-in { width: 100%; height: 100%; border: 4px solid; animation: shrink 1.8s linear infinite; }
        @keyframes shrink { 0% { width: 100%; height: 100%; opacity: 0; } 10% { opacity: 1; } 100% { width: 0%; height: 0%; } }

        /* Ball */
        #ball-wrap {
            position: absolute; width: 70px; height: 70px;
            left: 50%; bottom: 15%; 
            transform: translate3d(-50%, 0, 0); /* Centered X */
            z-index: 100; pointer-events: none; will-change: transform, left, top;
        }
        #ball-img {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: contain; background-repeat: no-repeat;
            border-radius: 50%;
        }

        /* UI */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
        .toast {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 900; font-size: 24px;
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid #333;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        .hud-btn {
            position: absolute; bottom: 30px; background: white; padding: 12px 18px; border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); pointer-events: auto; display: flex; align-items: center; gap: 8px; font-weight: bold;
        }
        
        #menu-pnl {
            position: absolute; bottom: 0; left: 0; width: 100%; background: #fff;
            border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s; pointer-events: auto; z-index: 300;
        }
        #menu-pnl.open { transform: translateY(0); }
        .row { display: flex; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        /* Effects */
        .sparkle { animation: flash 0.5s; }
        @keyframes flash { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.5); filter: brightness(5); } }
        .shake { animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } }

    </style>
</head>
<body>

<div id="world">
    <div class="hill" style="background:#81C784; left:-80px;"></div>
    <div class="hill" style="background:#66BB6A; right:-50px; bottom:38%;"></div>

    <div id="pokemon-wrap">
        <div style="background:rgba(255,255,255,0.8); padding:5px 12px; border-radius:15px; font-weight:bold; margin-bottom:5px;">Pikachu CP 1850</div>
        <div style="position:relative;">
            <img id="poke-sprite" src="" />
            <div id="ring-sys">
                <div id="r-out" class="ring"></div>
                <div id="r-in" class="ring"></div>
            </div>
        </div>
    </div>

    <div id="ball-wrap">
        <div id="ball-img"></div>
    </div>
</div>

<div id="ui">
    <div id="toast" class="toast">Excellent!</div>

    <div class="hud-btn" style="left:20px;" onclick="ui.menu('berry')">Berry</div>
    <div class="hud-btn" style="right:20px;" onclick="ui.menu('ball')">
        <img id="hud-icon" width="24" src=""> Balls
    </div>

    <div id="menu-pnl">
        <div style="text-align:center; font-weight:bold; color:#555; margin-bottom:10px;">ITEMS</div>
        <div id="menu-list" style="max-height:300px; overflow-y:auto;"></div>
        <button onclick="ui.close()" style="width:100%; padding:15px; background:#f0f0f0; border:none; margin-top:10px; border-radius:10px; font-weight:bold;">Cancel</button>
    </div>
</div>

<script>
    const ASSETS = {
        poke: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/",
        item: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/"
    };

    const DATA = {
        inv: {
            'Poke Ball': { t:'ball', img:'poke-ball.png', qty:50 },
            'Great Ball': { t:'ball', img:'great-ball.png', qty:20 },
            'Ultra Ball': { t:'ball', img:'ultra-ball.png', qty:10 },
            'Master Ball': { t:'ball', img:'master-ball.png', qty:1 },
            'Razz Berry': { t:'berry', img:'razz-berry.png', qty:5 }
        },
        mon: [ {id:25, n:'Pikachu'}, {id:133, n:'Eevee'}, {id:1, n:'Bulbasaur'}, {id:6, n:'Charizard'} ]
    };

    // --- PHYSICS VARS ---
    const STATE = {
        mode: 'idle', // idle, hold, fly, catch
        ball: 'Poke Ball',
        berry: null,
        
        // Physics
        pos: { x:0, y:0, z:0 },
        vel: { x:0, y:0, z:0 },
        spin: 0, // Angular velocity for curve
        rot: 0, // Visual rotation angle
    };

    const INPUT = {
        active: false,
        hist: [],
        last: { x:0, y:0, t:0 }
    };

    const LOGIC = {
        init: () => {
            ui.hud();
            LOGIC.spawn();
            
            // Listeners
            const s = document.body;
            s.addEventListener('touchstart', LOGIC.start, {passive:false});
            s.addEventListener('touchmove', LOGIC.move, {passive:false});
            s.addEventListener('touchend', LOGIC.end, {passive:false});
            
            // Mouse
            s.addEventListener('mousedown', LOGIC.start);
            window.addEventListener('mousemove', LOGIC.move);
            window.addEventListener('mouseup', LOGIC.end);

            requestAnimationFrame(LOGIC.loop);
        },

        spawn: () => {
            const m = DATA.mon[Math.floor(Math.random()*DATA.mon.length)];
            document.getElementById('poke-sprite').src = ASSETS.poke + m.id + '.png';
            document.getElementById('poke-sprite').style.opacity = 1;
            document.getElementById('poke-sprite').style.transform = 'scale(1)';
            document.getElementById('ring-sys').style.display = 'flex';
            document.getElementById('r-in').style.borderColor = Math.random()>0.5 ? 'red' : 'orange';
            LOGIC.reset();
        },

        reset: () => {
            STATE.mode = 'idle';
            STATE.spin = 0;
            STATE.rot = 0;
            const b = document.getElementById('ball-wrap');
            b.style.transition = 'all 0.4s cubic-bezier(0.19, 1, 0.22, 1)';
            b.style.left = '50%';
            b.style.top = 'auto'; 
            b.style.bottom = '15%';
            b.style.transform = 'translate3d(-50%, 0, 0) scale(1)';
            document.getElementById('ball-img').style.transform = 'rotate(0deg)';
            b.style.display = 'block';
        },

        // --- INPUT ---
        start: (e) => {
            if (STATE.mode !== 'idle') return;
            const p = e.touches ? e.touches[0] : e;
            const h = window.innerHeight;
            
            // Allow grab bottom 60%
            if (p.clientY < h * 0.4) return;
            
            e.preventDefault();
            INPUT.active = true;
            STATE.mode = 'hold';
            INPUT.hist = [];
            
            // Visual Snap to finger
            const b = document.getElementById('ball-wrap');
            b.style.transition = 'none'; // Instant follow
            b.style.transform = 'translate3d(-50%, -50%, 0) scale(1.1)'; // Held scale
            
            LOGIC.track(p.clientX, p.clientY);
        },

        move: (e) => {
            if (!INPUT.active) return;
            e.preventDefault();
            const p = e.touches ? e.touches[0] : e;
            LOGIC.track(p.clientX, p.clientY);
        },

        track: (x, y) => {
            const now = Date.now();
            INPUT.hist.push({x, y, t:now});
            if (INPUT.hist.length > 8) INPUT.hist.shift(); // Keep last 8 frames

            // Update Ball Position immediately
            STATE.pos.x = x;
            STATE.pos.y = y;

            // SPIN CALCULATION
            if (INPUT.hist.length > 2) {
                const prev = INPUT.hist[INPUT.hist.length-2];
                const dx = x - prev.x;
                const dy = y - prev.y;
                
                // Rotational movement detection (Cross Product-ish)
                // This detects if we are moving in a circle
                const cx = window.innerWidth / 2;
                const cy = window.innerHeight * 0.8; // Rough center of spin area
                
                // Simple spin accumulation based on lateral velocity
                STATE.spin = dx * 1.5; 
                STATE.rot += STATE.spin;
            }
        },

        end: (e) => {
            if (!INPUT.active) return;
            INPUT.active = false;
            
            const hist = INPUT.hist;
            if (hist.length < 3) { LOGIC.reset(); return; }
            
            const start = hist[0];
            const end = hist[hist.length-1];
            const dt = end.t - start.t;
            
            // Anti-Hold
            if (Date.now() - end.t > 150) { LOGIC.reset(); return; }

            const vx = (end.x - start.x) / dt;
            const vy = (end.y - start.y) / dt;

            // Throw Threshold
            if (vy > -0.5) { LOGIC.reset(); return; }

            // Launch
            if (DATA.inv[STATE.ball].qty > 0) DATA.inv[STATE.ball].qty--;
            ui.hud();
            
            STATE.mode = 'fly';
            STATE.vel.x = vx * 18;
            STATE.vel.y = vy * 18; 
            STATE.vel.z = Math.abs(vy) * 22; // Depth speed based on throw power
            
            // Curve Logic
            STATE.spin = (STATE.spin || 0) * 0.5; // Carry over spin momentum
            
            // Reset Z pos for flight
            STATE.pos.z = 0;
            // X/Y start from release point
            STATE.pos.x = end.x;
            STATE.pos.y = end.y;
        },

        // --- PHYSICS LOOP ---
        loop: () => {
            const b = document.getElementById('ball-wrap');
            const g = document.getElementById('ball-img');

            if (STATE.mode === 'hold') {
                // Follow Finger
                b.style.left = STATE.pos.x + 'px';
                b.style.top = STATE.pos.y + 'px';
                g.style.transform = `rotate(${STATE.rot}deg)`;
            }
            else if (STATE.mode === 'fly') {
                // Physics Steps
                STATE.pos.x += STATE.vel.x;
                STATE.pos.y += STATE.vel.y;
                STATE.pos.z += STATE.vel.z;

                // Gravity
                STATE.vel.vy += 0.7;
                
                // Magnus Effect (Curve)
                STATE.vel.x += STATE.spin * 0.1;
                
                // Drag
                STATE.vel.z *= 0.98;

                // Visual Render (Perspective)
                const d = 700;
                const scale = d / (d + STATE.pos.z);
                
                // Rotation visualization
                STATE.rot += STATE.spin * 2;

                b.style.left = STATE.pos.x + 'px';
                b.style.top = STATE.pos.y + 'px';
                b.style.transform = `translate3d(-50%, -50%, 0) scale(${scale})`;
                g.style.transform = `rotate(${STATE.rot}deg)`;

                // HIT Check (Depth ~100)
                if (STATE.pos.z > 90) {
                    // Check Screen Coords against Target
                    const t = document.getElementById('pokemon-wrap').getBoundingClientRect();
                    // Ball center
                    const bx = STATE.pos.x;
                    const by = STATE.pos.y;
                    
                    if (bx > t.left && bx < t.right && by > t.top && by < t.bottom) {
                        LOGIC.hit();
                    } else if (STATE.pos.z > 200) {
                        // Missed depth
                        LOGIC.miss();
                    }
                }
                
                // Floor/Sky Check
                if (STATE.pos.y > window.innerHeight + 50) LOGIC.miss();
            }

            requestAnimationFrame(LOGIC.loop);
        },

        hit: () => {
            STATE.mode = 'catch';
            
            // Calculate Bonus
            const inner = document.getElementById('r-in').offsetWidth;
            const outer = document.getElementById('r-out').offsetWidth;
            const ratio = inner/outer;
            
            let txt="Nice!"; let col="#fff";
            if (ratio < 0.2) { txt="Excellent!"; col="#FFD700"; }
            else if (ratio < 0.5) { txt="Great!"; col="red"; }
            else if (ratio > 0.9) txt=""; 
            
            if(txt) ui.toast(txt, col);

            // Hide Rings
            document.getElementById('ring-sys').style.display = 'none';

            // Snap Animation
            const b = document.getElementById('ball-wrap');
            const t = document.getElementById('pokemon-wrap').getBoundingClientRect();
            b.style.transition = 'all 0.1s';
            b.style.left = (t.left + t.width/2) + 'px';
            b.style.top = (t.top + t.height/2) + 'px';
            b.style.transform = 'translate(-50%, -50%) scale(0.6)';

            // Suck
            const s = document.getElementById('poke-sprite');
            s.style.transition = 'all 0.4s';
            s.style.transform = 'scale(0) rotate(180deg)';
            s.style.opacity = 0;

            // Drop & Shake
            setTimeout(() => {
                b.style.transition = 'top 0.4s ease-out';
                b.style.top = (t.bottom + 60) + 'px';
                setTimeout(() => LOGIC.shake(0), 500);
            }, 400);
        },

        miss: () => {
            STATE.mode = 'idle';
            ui.toast("Miss!", "#aaa");
            setTimeout(LOGIC.reset, 500);
        },

        shake: (count) => {
            if (count >= 3) {
                ui.toast("Gotcha!", "#4CAF50");
                document.getElementById('ball-wrap').classList.add('sparkle');
                setTimeout(() => {
                    document.getElementById('ball-wrap').classList.remove('sparkle');
                    LOGIC.spawn();
                }, 2000);
                return;
            }

            const b = document.getElementById('ball-img');
            // Mock Catch Rate (50%)
            if (Math.random() > 0.5) {
                b.style.animation = 'none';
                b.offsetHeight;
                b.parentElement.style.animation = 'shake 0.8s';
                setTimeout(() => LOGIC.shake(count+1), 1000);
            } else {
                ui.toast("Escaped!");
                document.getElementById('ball-wrap').style.display = 'none';
                const s = document.getElementById('poke-sprite');
                s.style.transform = 'scale(1)'; s.style.opacity = 1;
                document.getElementById('ring-sys').style.display = 'flex';
                setTimeout(LOGIC.reset, 1000);
            }
        }
    };

    const ui = {
        hud: () => {
            const i = DATA.inv[STATE.ball];
            document.getElementById('hud-icon').src = ASSETS.item + i.img;
            document.getElementById('ball-img').style.backgroundImage = `url('${ASSETS.item + i.img}')`;
        },
        menu: (type) => {
            if (STATE.mode !== 'idle') return;
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            for (let k in DATA.inv) {
                const i = DATA.inv[k];
                if (i.t !== type) continue;
                const r = document.createElement('div');
                r.className = 'row';
                r.onclick = () => {
                    if (type === 'ball') STATE.ball = k;
                    else if (type === 'berry') STATE.berry = k;
                    ui.hud(); ui.close();
                };
                r.innerHTML = `<img src="${ASSETS.item+i.img}" width="40" style="margin-right:10px"> <b>${k}</b> x${i.qty}`;
                list.appendChild(r);
            }
            document.getElementById('menu-pnl').classList.add('open');
        },
        close: () => document.getElementById('menu-pnl').classList.remove('open'),
        toast: (msg, col) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.color = col;
            t.style.borderColor = col;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }
    };

    window.onload = LOGIC.init;
</script>
</body>
</html>