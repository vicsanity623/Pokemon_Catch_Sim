<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- FORCE NO-CACHE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Pokémon Catch Sim v0.1.9</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5CA0F0">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png">

    <style>
        /* --- RESET & LAYOUT --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #5CA0F0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #game-stage {
            position: relative; width: 100%; height: 100%;
            overflow: hidden;
            background: linear-gradient(to bottom, #5CA0F0 0%, #C3E0F8 50%, #68A748 50%, #3B7E27 100%);
            perspective: 900px;
        }

        /* --- VERSION TAG --- */
        #version-tag {
            position: absolute; top: 10px; left: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px; font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            pointer-events: none; z-index: 1000;
        }

        /* --- PLAYER HUD (TOP CENTER) --- */
        #player-hud {
            position: absolute; top: 15px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 400px;
            display: flex; align-items: center;
            z-index: 400; pointer-events: none;
        }

        #avatar-bubble {
            width: 50px; height: 50px;
            background: white; border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 2; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }
        #avatar-bubble img { width: 100%; }

        #xp-bar-container {
            flex: 1; height: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: 0 10px 10px 0;
            margin-left: -25px; /* Tuck behind avatar */
            padding-left: 30px; /* Space for text */
            position: relative;
            overflow: hidden;
        }

        #xp-fill {
            height: 100%; width: 0%;
            background: #00E5FF;
            transition: width 0.5s ease-out;
        }

        #level-indicator {
            position: absolute; bottom: -5px; left: 0;
            background: #4CAF50; color: white;
            font-weight: bold; font-size: 14px;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white; z-index: 3;
        }

        /* --- POKEMON TARGET --- */
        #pokemon-container {
            position: absolute;
            top: 46%; left: 50%;
            transform: translate3d(-50%, -50%, -300px);
            width: 500px; height: 500px; /* INCREASED HITBOX SIZE */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none;
            will-change: transform;
        }

        #pokemon-sprite {
            width: 300px; height: 300px;
            object-fit: contain;
            filter: drop-shadow(0 20px 20px rgba(0,0,0,0.4));
            animation: idleHover 3s infinite ease-in-out;
            transition: transform 0.2s, opacity 0.2s;
        }
        @keyframes idleHover { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

        #cp-tag {
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 16px; border-radius: 16px;
            font-weight: 800; color: #333; font-size: 16px;
            margin-bottom: 20px; text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* --- TARGET RINGS --- */
        #ring-container {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -25%); 
            width: 450px; height: 450px; /* INCREASED VISUAL SIZE */
            display: flex; justify-content: center; align-items: center;
        }
        .ring { position: absolute; border-radius: 50%; box-sizing: border-box; }
        #ring-outer { width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.7); }
        #ring-target { 
            width: 100%; height: 100%; 
            border: 4px solid #ff0000; 
            animation: shrinkRing 1.8s linear infinite; 
        }
        @keyframes shrinkRing { 0% { transform: scale(1); opacity:1; } 100% { transform: scale(0); opacity:1; } }

        /* --- POKEBALL --- */
        #ball-container {
            position: absolute;
            width: 90px; height: 90px;
            left: 50%; bottom: 10%;
            transform: translate3d(-50%, 0, 0);
            z-index: 100;
            will-change: transform, top, left;
        }

        #ball-sprite {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: contain; background-repeat: no-repeat;
            border-radius: 50%;
        }
        
        .sparkle {
            position: absolute; width: 10px; height: 10px;
            background: #FFF700; border-radius: 50%;
            pointer-events: none; opacity: 0;
            box-shadow: 0 0 8px #FFF700;
        }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 200;
        }

        .ui-btn {
            position: absolute; bottom: 30px;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.95);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: auto; cursor: pointer;
            transition: transform 0.1s;
        }
        .ui-btn:active { transform: scale(0.9); }
        #btn-berry { left: 25px; }
        #btn-ball { right: 25px; }

        .float-text {
            position: absolute;
            font-family: 'Arial Black', sans-serif;
            font-size: 40px;
            color: white;
            -webkit-text-stroke: 1px black;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 1.5s ease-out forwards;
            white-space: nowrap;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
            100% { transform: translate(-50%, -150%); opacity: 0; }
        }
        /* Inventory Menus */
        .drawer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #fff; border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s ease-out;
            pointer-events: auto; z-index: 300;
        }
        .drawer.open { transform: translateY(0); }
        .drawer-item {
            display: flex; align-items: center; padding: 12px;
            border-bottom: 1px solid #eee;
        }

        #active-berry {
            position: absolute; top: 15%; right: 20px; width: 50px; display: none;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }

        /* --- SCREENS (Result / Level Up) --- */
        .full-screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 500;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
            opacity: 0; transition: opacity 0.5s;
        }
        .full-screen-overlay.visible { opacity: 1; }
        
        .header-text {
            font-family: 'Arial Black', sans-serif;
            font-size: 40px; color: #4CAF50;
            margin-bottom: 20px; text-align: center;
        }
        
        .stats-box {
            background: #f8f8f8;
            border-radius: 20px;
            padding: 25px;
            width: 85%; max-width: 320px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-row {
            display: flex; justify-content: space-between;
            margin: 8px 0; font-weight: bold; color: #666;
            font-size: 15px;
        }
        .stat-val { color: #222; }
        .bonus-row { color: #2196F3; font-size: 14px; }
        
        .resource-row {
            display: flex; justify-content: center; gap: 30px;
            margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px;
        }
        .res-item { display: flex; flex-direction: column; align-items: center; font-weight: bold; }
        .res-val { font-size: 22px; margin-top: 5px; }

        .btn-action {
            border: none; padding: 16px 20px;
            border-radius: 35px; font-size: 16px; font-weight: bold;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            cursor: pointer; transform: scale(1); transition: transform 0.1s;
            display: flex; align-items: center; gap: 8px; color: white;
        }
        .btn-action:active { transform: scale(0.95); }
        #btn-next { background: #4CAF50; }
        #btn-storage { background: #2196F3; }
        #btn-claim { background: #FF9800; padding: 16px 60px; font-size: 18px; margin-top: 20px; }

        /* Level Up Specifics */
        #lvl-up-rewards {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; margin-top: 20px;
        }
        .reward-item {
            background: white; padding: 10px; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Storage Screen */
        #storage-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f2f2f2; z-index: 600;
            display: none; flex-direction: column;
            pointer-events: auto;
        }
        #storage-header {
            background: white; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center; font-weight: bold; font-size: 18px; color: #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        #storage-grid {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; align-content: flex-start;
        }
        .storage-card {
            background: white; border-radius: 8px;
            padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-cp { font-size: 12px; font-weight: bold; color: #555; }
        .card-img { width: 80px; height: 80px; object-fit: contain; }
        .card-name { font-size: 13px; color: #333; font-weight: 500; }
        .card-date { font-size: 10px; color: #999; margin-top: 2px; }

        /* Animations */
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 20% {transform: translateX(-5px) rotate(-10deg)} 40% {transform: translateX(5px) rotate(10deg)} 60% {transform: translateX(-5px) rotate(-10deg)} 80% {transform: translateX(5px) rotate(10deg)} }
        
        .catch-flash { animation: catchFlash 0.5s; }
        @keyframes catchFlash { 0% {filter: brightness(1);} 50% {filter: brightness(5) sepia(1) hue-rotate(-50deg);} }

        /* --- POKEMON DETAIL SCREEN (pokemon.js) --- */
        #pokemon-detail-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); /* Grass Type feel */
            z-index: 700;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            overflow-y: auto; pointer-events: auto;
        }
        #pokemon-detail-screen.active { transform: translateY(0); }

        .pd-header { padding: 40px 20px 10px; text-align: center; }
        .pd-cp-label { font-size: 18px; color: white; font-weight: bold; }
        .pd-cp-val { font-size: 40px; }

        .pd-hero { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; min-height: 250px; }
        .pd-sprite { width: 200px; height: 200px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); z-index: 2; }
        .evolve-flash { animation: catchFlash 1s; }

        .pd-info-card {
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; min-height: 40%;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            color: #333;
        }

        .pd-name-row { text-align: center; margin-bottom: 10px; }
        .pd-name { font-size: 28px; font-weight: 500; color: #444; }
        .pd-pencil { color: #aaa; margin-left: 10px; font-style: normal; cursor: pointer; }

        .pd-hp-bar { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .pd-hp-fill { height: 100%; background: #4CAF50; }
        .pd-hp-text { text-align: center; font-size: 14px; color: #666; font-weight: bold; margin-bottom: 20px; }

        .pd-stats-row { display: flex; justify-content: space-around; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .pd-stat { display: flex; flex-direction: column; align-items: center; }
        .pd-stat-val { font-size: 18px; font-weight: bold; color: #333; }
        .pd-stat-label { font-size: 12px; color: #888; margin-top: 4px; }

        .pd-resources { display: flex; justify-content: space-around; margin: 20px 0; }
        .pd-res { display: flex; flex-direction: column; align-items: center; }
        .pd-res span { font-weight: bold; font-size: 16px; color: #333; }
        .pd-res-label { font-size: 11px; color: #888; margin-top: 4px; letter-spacing: 1px; }
        .pd-dust-icon { width: 10px; height: 10px; background: #9C27B0; border-radius: 50%; display:inline-block; margin-bottom: 5px; }
        .pd-candy-icon { width: 10px; height: 10px; background: orange; border-radius: 50%; display:inline-block; margin-bottom: 5px; }

        .pd-action-btn {
            background: #E0E0E0; border-radius: 40px;
            padding: 12px 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .pd-action-btn::before { content:''; position:absolute; left:0; top:0; height:100%; width: 30%; background: #4CAF50; border-radius: 40px 0 0 40px; z-index: 0; }
        .pd-evolve-btn::before { background: linear-gradient(90deg, #2196F3, #21CBF3); }
        
        .pd-btn-left { z-index: 1; color: white; font-weight: bold; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); padding-left: 10px; }
        .pd-btn-right { z-index: 1; display: flex; gap: 15px; }
        
        .pd-cost-item { display: flex; align-items: center; font-size: 14px; font-weight: bold; color: #333; }
        .pd-dust-tiny { width: 8px; height: 8px; background: #9C27B0; border-radius: 50%; margin-right: 5px; }
        .pd-candy-tiny { width: 8px; height: 8px; background: orange; border-radius: 50%; margin-right: 5px; }

        .pd-close-fab {
            position: absolute; bottom: 30px; right: 50%; transform: translateX(50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.1); border: 2px solid #888;
            color: #555; font-size: 24px; display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }

    </style>
    
    <!-- SAFE AUTO-UPDATE SCRIPT -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        registration.onupdatefound = () => {
                            const newWorker = registration.installing;
                            newWorker.onstatechange = () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    window.location.reload();
                                }
                            };
                        };
                    });
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
        }
    </script>
</head>
<body>

<div id="game-stage">
    <!-- Version Tag -->
    <div id="version-tag">v0.1.9</div>

    <!-- PLAYER HUD -->
    <div id="player-hud">
        <div id="avatar-bubble">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/red.png" alt="Trainer">
        </div>
        <div id="level-indicator">1</div>
        <div id="xp-bar-container">
            <div id="xp-fill"></div>
        </div>
    </div>

    <!-- WORLD -->
    <div id="pokemon-container">
        <div id="cp-tag">Loading...</div>
        <img id="active-berry" src="" />
        <img id="pokemon-sprite" src="" />
        <div id="ring-container">
            <div id="ring-outer" class="ring"></div>
            <div id="ring-target" class="ring"></div>
        </div>
    </div>
    <div id="ball-container">
        <div id="ball-sprite"></div>
    </div>
</div>

<div id="ui-layer">
    <div id="toast">Excellent!</div>

    <!-- Gameplay UI -->
    <div id="gameplay-ui">
        <div id="btn-berry" class="ui-btn" onclick="UI.open('berry')">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/razz-berry.png" width="36">
        </div>
        <div id="btn-ball" class="ui-btn" onclick="UI.open('ball')">
            <img id="current-ball-icon" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" width="36">
        </div>
    </div>

    <!-- Menus -->
    <div id="menu-drawer" class="drawer">
        <h3 id="drawer-title" style="text-align:center; color:#555; margin-top:0;">ITEMS</h3>
        <div id="drawer-list" style="max-height:60vh; overflow-y:auto;"></div>
        <button onclick="UI.close()" style="width:100%; padding:15px; margin-top:10px; border:none; background:#eee; font-weight:bold; border-radius:10px;">Close</button>
    </div>

    <!-- Result Screen -->
    <div id="result-overlay" class="full-screen-overlay">
        <div class="header-text">Gotcha!</div>
        <img id="res-poke-img" src="" width="140" style="margin-bottom:15px;">
        <div id="res-poke-name" style="font-weight:bold; color:#555; font-size: 18px; margin-bottom:10px;">Pikachu</div>
        <div class="stats-box">
            <div class="stat-row">
                <span>Pokémon Caught</span>
                <span class="stat-val">100 XP</span>
            </div>
            <div id="bonus-list"></div>
            <div class="stat-row" style="margin-top:15px; font-size:18px; border-top:1px solid #ddd; padding-top:10px;">
                <span>TOTAL</span>
                <span class="stat-val" id="total-xp-val" style="color:#4CAF50">100 XP</span>
            </div>
            <div class="resource-row">
                <div class="res-item" style="color:#E91E63">
                    <span>CANDY</span>
                    <span class="res-val" id="res-candy">+3</span>
                </div>
                <div class="res-item" style="color:#9C27B0">
                    <span>STARDUST</span>
                    <span class="res-val" id="res-dust">+100</span>
                </div>
            </div>
        </div>
        <div class="action-row" style="display:flex; gap:15px;">
            <button id="btn-storage" class="btn-action" onclick="UI.openStorage()">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" width="24"> Pokémon
            </button>
            <button id="btn-next" class="btn-action" onclick="Game.nextPokemon()">Next ➔</button>
        </div>
    </div>

    <!-- Level Up Screen -->
    <div id="levelup-overlay" class="full-screen-overlay">
        <div class="header-text" style="color:#FF9800">LEVEL UP!</div>
        <div id="new-level-num" style="font-size:80px; font-weight:900; color:#333; margin:20px 0;">2</div>
        <div class="stats-box">
            <div style="text-align:center; font-weight:bold; color:#666;">REWARDS</div>
            <div id="lvl-up-rewards"></div>
        </div>
        <button id="btn-claim" class="btn-action" onclick="Game.claimRewards()">CLAIM</button>
    </div>

    <!-- Storage Screen -->
    <div id="storage-screen">
        <div id="storage-header">
            <span>Pokemon Storage</span>
            <button onclick="UI.closeStorage()" style="border:none; background:none; font-size:24px; color:#555; padding:0 10px;">✕</button>
        </div>
        <div id="storage-grid"></div>
    </div>
</div>

<!-- POKEMON DETAIL CONTAINER -->
<div id="pokemon-detail-screen"></div>

<script>
    /* --- ASSETS & CONFIG --- */
    const ASSETS = {
        poke: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/",
        item: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/"
    };

    /* --- DATA PERSISTENCE --- */
    const STORAGE_KEY = 'pokecatch_v12_save';
    
    // Default State
    let Data = {
        user: { level: 1, xp: 0, nextLevelXp: 1000, candy: 0 },
        inventory: {
            'Poke Ball': 50, 'Great Ball': 10, 'Ultra Ball': 5, 'Master Ball': 1,
            'Stardust': 500, // Starting Stardust
            'Razz Berry': 10, 'Nanab Berry': 10, 'Pinap Berry': 10
        },
        storage: []
    };

    const Meta = {
        balls: {
            'Poke Ball': { img:'poke-ball.png', rate: 1.0 },
            'Great Ball': { img:'great-ball.png', rate: 1.5 },
            'Ultra Ball': { img:'ultra-ball.png', rate: 2.0 },
            'Master Ball': { img:'master-ball.png', rate: 100.0 }
        },
        berries: {
            'Razz Berry': { img:'razz-berry.png', mod: 1.5 },
            'Nanab Berry': { img:'nanab-berry.png', mod: 1.0 },
            'Pinap Berry': { img:'pinap-berry.png', mod: 1.0 }
        },
        // Fallback list
        mons: [
            {id:25, n:'Pikachu'}, {id:1, n:'Bulbasaur'}, {id:4, n:'Charmander'},
            {id:7, n:'Squirtle'}, {id:133, n:'Eevee'}, {id:143, n:'Snorlax'}
        ]
    };

    /* --- GAME ENGINE --- */
    const Game = {
        state: {
            mode: 'idle', ball: 'Poke Ball', berry: null, spin: 0, mon: null,
            pos: {x:0, y:0, z:0}, vel: {x:0, y:0, z:0}, rot: 0,
            throwGrade: null, isCurve: false, shakeTarget: 0, transitioning: false
        },

        init: () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) Data = JSON.parse(saved);
            if (!Data.inventory['Stardust']) Data.inventory['Stardust'] = 500;
            if (!Data.user.candy) Data.user.candy = 0;

            UI.updateHUD();
            Game.spawn();
            
            const stage = document.body;
            stage.addEventListener('touchstart', Input.start, {passive: false});
            stage.addEventListener('touchmove', Input.move, {passive: false});
            stage.addEventListener('touchend', Input.end, {passive: false});
            stage.addEventListener('mousedown', Input.start);
            window.addEventListener('mousemove', Input.move);
            window.addEventListener('mouseup', Input.end);

            requestAnimationFrame(Game.loop);
        },

        save: () => localStorage.setItem(STORAGE_KEY, JSON.stringify(Data)),

        spawn: () => {
            Game.state.transitioning = false;
            // DYNAMIC SPAWN LOGIC
            function trySpawn() {
                const id = Math.floor(Math.random() * 1025) + 1;
                const cp = Math.floor(Math.random() * 2500) + 100;
                fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`).then(res=>res.json()).then(sd => {
                    if (sd.evolves_from_species !== null || (sd.is_legendary && Math.random()>0.05)) { trySpawn(); return; }
                    const name = sd.name.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
                    Game.state.mon = { id, n:name, cp, family:name };
                    Game.state.berry = null;
                    
                    const s = document.getElementById('pokemon-sprite');
                    s.style.opacity = 0;
                    document.getElementById('cp-tag').innerText = `${name} CP ${cp}`;
                    
                    fetch(`https://pokeapi.co/api/v2/pokemon/${id}`).then(r=>r.json()).then(pd => {
                        s.src = pd.sprites.other['official-artwork'].front_default || pd.sprites.front_default;
                        s.onload = () => { s.style.transform='scale(1)'; s.style.opacity=1; };
                    });

                    document.getElementById('active-berry').style.display='none';
                    document.getElementById('ring-container').style.display='flex';
                    document.getElementById('gameplay-ui').style.display='block';
                    document.getElementById('ring-target').style.borderColor = ['#FF0000','#FF9800','#4CAF50'][Math.floor(Math.random()*3)];
                    Game.resetBall();
                }).catch(()=>{
                    const m = Meta.mons[Math.floor(Math.random()*Meta.mons.length)];
                    Game.state.mon = {...m, cp, family:m.n};
                    document.getElementById('cp-tag').innerText = `${m.n} CP ${cp}`;
                    document.getElementById('pokemon-sprite').src = ASSETS.poke+m.id+'.png';
                    document.getElementById('pokemon-sprite').style.opacity = 1;
                    Game.resetBall();
                });
            }
            trySpawn();
        },

        resetBall: () => {
            Game.state.mode = 'idle'; Game.state.spin = 0; Game.state.rot = 0;
            Game.state.throwGrade = null; Game.state.isCurve = false;
            const b = document.getElementById('ball-container');
            b.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            b.style.left = '50%'; b.style.top = 'auto'; b.style.bottom = '10%';
            b.style.transform = 'translate3d(-50%, 0, 0) scale(1)';
            b.style.display = 'block';
            document.getElementById('ball-sprite').style.transform = 'rotate(0deg)';
        },

        loop: () => {
            const s = Game.state;
            if (s.mode === 'hold') {
                // Visual Spin
                if (Math.abs(s.spin) > 0.3) {
                    s.rot += s.spin * 20;
                    document.getElementById('ball-sprite').style.transform = `rotate(${s.rot}deg)`;
                    if(Math.abs(s.spin) > 1.5 && Math.random() > 0.6) FX.sparkle(s.pos.x, s.pos.y);
                }
                s.spin *= 0.92; // Friction
            }
            else if (s.mode === 'fly') {
                // Physics
                s.pos.x += s.vel.x;
                s.pos.y += s.vel.y;
                s.pos.z += s.vel.z;
                
                s.vel.y += 0.9; // Gravity
                s.vel.z *= 0.99; // Drag
                s.vel.x += s.spin * 0.5; // Magnus Effect (Curve)
                s.rot += s.spin * 25 + 5; 

                // Render 3D Perspective
                const scale = 900 / (900 + s.pos.z);
                const b = document.getElementById('ball-container');
                b.style.left = s.pos.x + 'px';
                b.style.top = s.pos.y + 'px';
                b.style.transform = `translate3d(-50%, -50%, 0) scale(${scale})`;
                document.getElementById('ball-sprite').style.transform = `rotate(${s.rot}deg)`;

                // HITBOX DETECTION
                // Pokemon depth is approx 300. Check window 280-350
                if (s.pos.z > 280 && s.pos.z < 350) {
                    const rect = document.getElementById('pokemon-container').getBoundingClientRect();
                    // Ball screen X/Y vs Pokemon Rect
                    if (s.pos.x > rect.left && s.pos.x < rect.right && s.pos.y > rect.top && s.pos.y < rect.bottom) {
                        Game.hit();
                    }
                }
                
                // Miss
                if (s.pos.z > 450 || s.pos.y > window.innerHeight) Game.miss();
            }
            requestAnimationFrame(Game.loop);
        },

        hit: () => {
            Game.state.mode = 'catch';
            
            // --- GEOMETRIC ACCURACY CHECK ---
            // 1. Get Ball Center vs Ring Center distance
            const ballRect = document.getElementById('ball-container').getBoundingClientRect();
            const bx = ballRect.left + ballRect.width/2;
            const by = ballRect.top + ballRect.height/2;
            
            const ringRect = document.getElementById('ring-target').getBoundingClientRect();
            const rx = ringRect.left + ringRect.width/2;
            const ry = ringRect.top + ringRect.height/2;
            const dist = Math.sqrt(Math.pow(bx - rx, 2) + Math.pow(by - ry, 2));
            
            // 2. Check if inside inner ring radius (+15px leniency for ball radius)
            const innerRadius = ringRect.width / 2;
            const landedInRing = dist < (innerRadius + 15);

            // 3. Calculate Grade
            const outerWidth = document.getElementById('ring-outer').offsetWidth;
            const targetWidth = document.getElementById('ring-target').offsetWidth;
            const ratio = targetWidth / outerWidth;

            let msg = "", col = "white", gradeBonus = 1.0;

            if (landedInRing) {
                if (ratio < 0.3) { msg = "Excellent!"; col = "#FFD700"; Game.state.throwGrade = "Excellent"; gradeBonus = 1.85; }
                else if (ratio < 0.5) { msg = "Great!"; col = "#F44336"; Game.state.throwGrade = "Great"; gradeBonus = 1.5; }
                else { msg = "Nice!"; col = "white"; Game.state.throwGrade = "Nice"; gradeBonus = 1.2; }
            } else {
                Game.state.throwGrade = null; // Hit Pokemon but missed circle
            }

            // Curve Logic Fix: Check if spin was significant at start
            if (Game.state.isCurve) {
                // If text exists, append curve icon or separate toast? 
                // For now, just Curve bonus applies in background
            } else if (!msg) {
                // Optional: "Curveball!" text if catching without accuracy bonus?
                // Keeping it simple to match GO: Text only shows for accuracy.
            }

            if (msg) UI.spawnFloatText(msg, bx, by, col);

            // --- CATCH CALCULATION ---
            let base = 0.40;
            const ballRate = Meta.balls[Game.state.ball].rate;
            const berryMod = Game.state.berry ? Meta.berries[Game.state.berry].mod : 1.0;
            const curveMod = Game.state.isCurve ? 1.7 : 1.0; // Boosted Curve Bonus
            
            let chance = base * ballRate * berryMod * gradeBonus * curveMod;
            if (Game.state.ball === 'Master Ball') chance = 999;
            
            Game.state.shakeTarget = (Math.random() < chance) ? 3 : Math.floor(Math.random() * 3);

            // Visual Capture Sequence
            document.getElementById('ring-container').style.display = 'none';
            const b = document.getElementById('ball-container');
            const p = document.getElementById('pokemon-container').getBoundingClientRect();
            
            b.style.transition = 'all 0.1s linear';
            b.style.left = (p.left + p.width/2) + 'px';
            b.style.top = (p.top + p.height/2) + 'px';
            b.style.transform = `translate(-50%, -50%) scale(0.7)`;
            
            const s = document.getElementById('pokemon-sprite');
            s.style.transition = 'all 0.4s ease-in';
            s.style.transform = 'scale(0) rotate(270deg)';
            s.style.opacity = 0;

            setTimeout(() => {
                b.style.transition = 'top 0.4s ease-out';
                b.style.top = (p.bottom - 40) + 'px';
                setTimeout(() => Game.playShake(0), 400);
            }, 400);
        },

        playShake: (count) => {
            const b = document.getElementById('ball-sprite');
            if(count >= 3) {
                document.getElementById('ball-container').classList.add('catch-flash');
                Data.storage.unshift({
                    id: Game.state.mon.id, name: Game.state.mon.n,
                    cp: Game.state.mon.cp, family: Game.state.mon.family,
                    date: new Date().toLocaleDateString()
                });
                Game.save();
                setTimeout(() => {
                    document.getElementById('ball-container').classList.remove('catch-flash');
                    Game.showResults();
                }, 1000);
                return;
            }
            if(count < Game.state.shakeTarget) {
                b.style.animation = 'none'; b.offsetHeight; 
                b.parentElement.classList.add('shake');
                setTimeout(() => { b.parentElement.classList.remove('shake'); Game.playShake(count+1); }, 1000);
            } else {
                UI.spawnFloatText("Escaped!", window.innerWidth/2, window.innerHeight/2, "white");
                document.getElementById('ball-container').style.display = 'none';
                const s = document.getElementById('pokemon-sprite');
                s.style.transform = 'scale(1)'; s.style.opacity = 1;
                document.getElementById('ring-container').style.display = 'flex';
                Game.state.berry = null; document.getElementById('active-berry').style.display = 'none';
                setTimeout(Game.resetBall, 1000);
            }
        },

        showResults: () => {
            const s = Game.state;
            const res = document.getElementById('result-overlay');
            const list = document.getElementById('bonus-list');
            document.getElementById('res-poke-img').src = document.getElementById('pokemon-sprite').src;
            document.getElementById('res-poke-name').innerText = s.mon.n + " (CP " + s.mon.cp + ")";
            
            let xp = 100;
            list.innerHTML = '';
            
            if (s.throwGrade) {
                let bonus = s.throwGrade === 'Excellent' ? 1000 : (s.throwGrade === 'Great' ? 500 : 100);
                xp += bonus;
                list.innerHTML += `<div class="stat-row bonus-row"><span>${s.throwGrade} Throw</span><span>+${bonus} XP</span></div>`;
            }
            if (s.isCurve) {
                xp += 20;
                list.innerHTML += `<div class="stat-row bonus-row"><span>Curveball</span><span>+20 XP</span></div>`;
            }

            document.getElementById('total-xp-val').innerText = xp + " XP";
            let candy = s.berry === 'Pinap Berry' ? 6 : 3;
            document.getElementById('res-candy').innerText = "+" + candy;

            Data.user.xp += xp; Data.inventory['Stardust'] += 100; Data.user.candy += candy;
            if (Data.user.xp >= Data.user.nextLevelXp) setTimeout(Game.levelUp, 1000);
            else { Game.save(); UI.updateHUD(); }

            document.getElementById('gameplay-ui').style.display = 'none';
            res.style.display = 'flex'; setTimeout(() => res.classList.add('visible'), 10);
        },

        levelUp: () => {
            document.getElementById('result-overlay').style.display = 'none';
            Data.user.level++; Data.user.xp -= Data.user.nextLevelXp;
            Data.user.nextLevelXp = Math.floor(Data.user.nextLevelXp * 1.5);
            const rewards = [];
            for(let i=0; i<5; i++) {
                const keys = Object.keys(Data.inventory);
                const item = keys[Math.floor(Math.random()*keys.length)];
                if(item !== 'Master Ball' && item !== 'Stardust') { Data.inventory[item]+=5; rewards.push(item); }
            }
            Game.save(); UI.updateHUD();
            document.getElementById('new-level-num').innerText = Data.user.level;
            const grid = document.getElementById('lvl-up-rewards'); grid.innerHTML = '';
            const counts = {}; rewards.forEach(x => counts[x] = (counts[x]||0)+5);
            for (let k in counts) {
                let img = Meta.balls[k] ? Meta.balls[k].img : Meta.berries[k].img;
                grid.innerHTML += `<div class="reward-item"><img src="${ASSETS.item + img}" width="40"><span style="font-weight:bold; margin-top:5px;">+${counts[k]}</span></div>`;
            }
            const lvl = document.getElementById('levelup-overlay');
            lvl.style.display = 'flex'; setTimeout(() => lvl.classList.add('visible'), 10);
        },
        claimRewards: () => { document.getElementById('levelup-overlay').classList.remove('visible'); setTimeout(() => { document.getElementById('levelup-overlay').style.display='none'; Game.nextPokemon(); }, 300); },
        nextPokemon: () => {
            if (Game.state.transitioning) return; Game.state.transitioning = true;
            document.getElementById('result-overlay').classList.remove('visible');
            setTimeout(() => { document.getElementById('result-overlay').style.display='none'; Game.spawn(); }, 300);
        },
        miss: () => { Game.state.mode = 'idle'; UI.spawnFloatText("Miss!", window.innerWidth/2, window.innerHeight-100, "#aaa"); setTimeout(Game.resetBall, 600); }
    };

    /* --- INPUT SYSTEM --- */
    const Input = {
        active: false, hist: [],
        start: (e) => {
            if (Game.state.mode !== 'idle') return;
            const p = e.touches ? e.touches[0] : e;
            const rect = document.getElementById('ball-container').getBoundingClientRect();
            if (p.clientX < rect.left - 100 || p.clientX > rect.right + 100 || p.clientY < rect.top - 100) return;
            e.preventDefault(); Input.active = true; Game.state.mode = 'hold'; Input.hist = [];
            const b = document.getElementById('ball-container');
            b.style.transition = 'none'; b.style.transform = `translate3d(-50%, -50%, 0) scale(1.15)`;
            Input.track(p.clientX, p.clientY);
        },
        move: (e) => { if (Input.active) { e.preventDefault(); const p = e.touches ? e.touches[0] : e; Input.track(p.clientX, p.clientY); } },
        track: (x, y) => {
            const now = Date.now(); Input.hist.push({x, y, t:now});
            if (Input.hist.length > 8) Input.hist.shift();
            Game.state.pos.x = x; Game.state.pos.y = y;
            if (Input.hist.length > 3) {
                const prev = Input.hist[Input.hist.length-2];
                // Spin Accumulation
                Game.state.spin = (x - prev.x) * 0.8; 
            }
        },
        end: (e) => {
            if (!Input.active) return; Input.active = false;
            const hist = Input.hist;
            if(hist.length < 2 || Date.now() - hist[hist.length-1].t > 150) { Game.resetBall(); return; }
            
            const start = hist[0]; const end = hist[hist.length-1]; const dt = end.t - start.t;
            const vx = (end.x - start.x) / dt;
            const vy = (end.y - start.y) / dt;
            
            if (vy > -0.5) { Game.resetBall(); return; } // Too slow
            if(Data.inventory[Game.state.ball] > 0) Data.inventory[Game.state.ball]--;
            UI.updateIcon();

            // SENSITIVE CURVE DETECTION (Fixing the issue)
            // Lowered threshold from 2.0 to 0.5 to catch lighter spins
            Game.state.isCurve = Math.abs(Game.state.spin) > 0.5;

            Game.state.mode = 'fly';
            document.getElementById('ball-container').style.transition = 'none';
            // Adjusted Physics Multipliers for "Feel"
            Game.state.vel.x = vx * 14; 
            Game.state.vel.y = vy * 15; 
            Game.state.vel.z = Math.abs(vy) * 28; 
            Game.state.pos.z = 0;
        }
    };

    /* --- FX & UI --- */
    const FX = {
        sparkle: (x, y) => {
            const el = document.createElement('div'); el.className = 'sparkle';
            el.style.left = (x + (Math.random()-0.5)*80) + 'px'; el.style.top = (y + (Math.random()-0.5)*80) + 'px';
            document.body.appendChild(el);
            requestAnimationFrame(() => { el.style.transition = 'all 0.5s ease-out'; el.style.opacity = 1; el.style.transform = 'scale(0)'; setTimeout(() => el.remove(), 500); });
        }
    };

    const UI = {
        spawnFloatText: (text, x, y, color) => {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            if(color) el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        },
        updateHUD: () => {
            document.getElementById('level-indicator').innerText = Data.user.level;
            const pct = Math.min(100, (Data.user.xp / Data.user.nextLevelXp) * 100);
            document.getElementById('xp-fill').style.width = pct + '%';
            Game.save();
        },
        open: (type) => {
            if(Game.state.mode !== 'idle') return;
            const list = document.getElementById('drawer-list'); list.innerHTML = '';
            document.getElementById('drawer-title').innerText = "SELECT " + type.toUpperCase();
            for(let key in Data.inventory) {
                if (key === 'Stardust') continue; 
                if ( (type==='ball' && !Meta.balls[key]) || (type==='berry' && !Meta.berries[key]) ) continue;
                const img = type === 'ball' ? Meta.balls[key].img : Meta.berries[key].img;
                const row = document.createElement('div'); row.className = 'drawer-item';
                row.onclick = () => UI.select(type, key);
                row.innerHTML = `<img src="${ASSETS.item + img}" width="40" style="margin-right:15px"><div style="flex:1"><b>${key}</b><br><small>x${Data.inventory[key]}</small></div>`;
                list.appendChild(row);
            }
            document.getElementById('menu-drawer').classList.add('open');
        },
        close: () => document.getElementById('menu-drawer').classList.remove('open'),
        select: (type, key) => {
            if(Data.inventory[key] <= 0) return;
            if(type === 'ball') { Game.state.ball = key; UI.updateIcon(); }
            else { 
                if(Game.state.berry) return; 
                Data.inventory[key]--; Game.state.berry = key; 
                document.getElementById('active-berry').src = ASSETS.item + Meta.berries[key].img; 
                document.getElementById('active-berry').style.display = 'block'; 
                UI.spawnFloatText(key + "!", window.innerWidth/2, window.innerHeight/2, "#E91E63"); 
            }
            UI.close(); UI.updateHUD();
        },
        updateIcon: () => {
            const img = Meta.balls[Game.state.ball].img;
            document.getElementById('current-ball-icon').src = ASSETS.item + img;
            document.getElementById('ball-sprite').style.backgroundImage = `url('${ASSETS.item + img}')`;
        },
        openStorage: () => {
            const grid = document.getElementById('storage-grid'); grid.innerHTML = '';
            Data.storage.forEach((p, index) => {
                const card = document.createElement('div'); card.className = 'storage-card';
                card.onclick = () => PokeDetail.open(index); 
                card.innerHTML = `<div class="card-cp">CP ${p.cp}</div><img class="card-img" src="${ASSETS.poke + p.id + '.png'}"><div class="card-name">${p.name}</div><div class="card-date">${p.date}</div>`;
                grid.appendChild(card);
            });
            document.getElementById('storage-screen').style.display = 'flex';
        },
        closeStorage: () => {
            document.getElementById('storage-screen').style.display = 'none';
        }
    };

    window.onload = Game.init;
</script>

<!-- LOAD NEW LOGIC -->
<script src="pokemon.js"></script>

</body>
</html>