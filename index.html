<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- FORCE NO-CACHE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Pokémon Catch Sim v11</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5CA0F0">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png">

    <style>
        /* --- RESET & LAYOUT --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #5CA0F0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #game-stage {
            position: relative; width: 100%; height: 100%;
            overflow: hidden;
            background: linear-gradient(to bottom, 
                #5CA0F0 0%, 
                #C3E0F8 50%, 
                #68A748 50%, 
                #3B7E27 100%
            );
            perspective: 900px;
        }

        /* --- POKEMON TARGET --- */
        #pokemon-container {
            position: absolute;
            top: 46%; left: 50%;
            transform: translate3d(-50%, -50%, -300px);
            width: 400px; height: 400px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none;
            will-change: transform;
        }

        #pokemon-sprite {
            width: 300px; height: 300px;
            object-fit: contain;
            filter: drop-shadow(0 20px 20px rgba(0,0,0,0.4));
            animation: idleHover 3s infinite ease-in-out;
            transition: transform 0.2s, opacity 0.2s;
        }
        @keyframes idleHover { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

        #cp-tag {
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 16px; border-radius: 16px;
            font-weight: 800; color: #333; font-size: 16px;
            margin-bottom: 20px; text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* --- TARGET RINGS --- */
        #ring-container {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -25%); 
            width: 220px; height: 220px;
            display: flex; justify-content: center; align-items: center;
        }
        .ring { position: absolute; border-radius: 50%; box-sizing: border-box; }
        #ring-outer { width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.7); }
        #ring-target { 
            width: 100%; height: 100%; 
            border: 4px solid #ff0000; 
            animation: shrinkRing 1.8s linear infinite; 
        }
        @keyframes shrinkRing { 0% { transform: scale(1); opacity:1; } 100% { transform: scale(0); opacity:1; } }

        /* --- POKEBALL --- */
        #ball-container {
            position: absolute;
            width: 90px; height: 90px;
            left: 50%; bottom: 10%;
            transform: translate3d(-50%, 0, 0);
            z-index: 100;
            will-change: transform, top, left;
        }

        #ball-sprite {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: contain; background-repeat: no-repeat;
            border-radius: 50%;
        }
        
        .sparkle {
            position: absolute; width: 10px; height: 10px;
            background: #FFF700; border-radius: 50%;
            pointer-events: none; opacity: 0;
            box-shadow: 0 0 8px #FFF700;
        }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 200;
        }

        .ui-btn {
            position: absolute; bottom: 30px;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.95);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: auto; cursor: pointer;
            transition: transform 0.1s;
        }
        .ui-btn:active { transform: scale(0.9); }
        #btn-berry { left: 25px; }
        #btn-ball { right: 25px; }

        #toast {
            position: absolute; top: 35%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-family: 'Arial Black', sans-serif;
            font-size: 36px; color: white;
            text-shadow: 0 0 5px black, 3px 3px 0 black;
            opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Inventory Menus */
        .drawer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #fff; border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s ease-out;
            pointer-events: auto; z-index: 300;
        }
        .drawer.open { transform: translateY(0); }
        .drawer-item {
            display: flex; align-items: center; padding: 12px;
            border-bottom: 1px solid #eee;
        }

        #active-berry {
            position: absolute; top: 15%; right: 20px; width: 50px; display: none;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }

        /* --- RESULT SCREEN --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 500;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
            opacity: 0; transition: opacity 0.5s;
        }
        #result-overlay.visible { opacity: 1; }
        
        #result-header {
            font-family: 'Arial Black', sans-serif;
            font-size: 40px; color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .result-stats-box {
            background: #f8f8f8;
            border-radius: 20px;
            padding: 25px;
            width: 85%; max-width: 320px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-row {
            display: flex; justify-content: space-between;
            margin: 8px 0; font-weight: bold; color: #666;
            font-size: 15px;
        }
        .stat-val { color: #222; }
        .bonus-row { color: #2196F3; font-size: 14px; }
        
        .resource-row {
            display: flex; justify-content: center; gap: 30px;
            margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px;
        }
        .res-item { display: flex; flex-direction: column; align-items: center; font-weight: bold; }
        .res-val { font-size: 22px; margin-top: 5px; }

        /* Action Buttons Row */
        .action-row {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .btn-action {
            border: none; padding: 16px 20px;
            border-radius: 35px; font-size: 16px; font-weight: bold;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            cursor: pointer; transform: scale(1); transition: transform 0.1s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-action:active { transform: scale(0.95); }

        #btn-next { background: #4CAF50; color: white; }
        #btn-storage { background: #2196F3; color: white; }

        /* --- POKEMON STORAGE SCREEN --- */
        #storage-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f2f2f2; z-index: 600;
            display: none; flex-direction: column;
            pointer-events: auto;
        }
        #storage-header {
            background: white; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center; font-weight: bold; font-size: 18px; color: #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        #storage-grid {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; align-content: flex-start;
        }
        .storage-card {
            background: white; border-radius: 8px;
            padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-cp { font-size: 12px; font-weight: bold; color: #555; }
        .card-img { width: 80px; height: 80px; object-fit: contain; }
        .card-name { font-size: 13px; color: #333; font-weight: 500; }
        .card-date { font-size: 10px; color: #999; margin-top: 2px; }

        /* Animations */
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 20% {transform: translateX(-5px) rotate(-10deg)} 40% {transform: translateX(5px) rotate(10deg)} 60% {transform: translateX(-5px) rotate(-10deg)} 80% {transform: translateX(5px) rotate(10deg)} }
        
        .catch-flash { animation: catchFlash 0.5s; }
        @keyframes catchFlash { 0% {filter: brightness(1);} 50% {filter: brightness(5) sepia(1) hue-rotate(-50deg);} }

    </style>
    
    <!-- SAFE AUTO-UPDATE SCRIPT -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        registration.onupdatefound = () => {
                            const newWorker = registration.installing;
                            newWorker.onstatechange = () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    window.location.reload();
                                }
                            };
                        };
                    });
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
        }
    </script>
</head>
<body>

<div id="game-stage">
    <div id="pokemon-container">
        <div id="cp-tag">Loading...</div>
        <img id="active-berry" src="" />
        <img id="pokemon-sprite" src="" />
        <div id="ring-container">
            <div id="ring-outer" class="ring"></div>
            <div id="ring-target" class="ring"></div>
        </div>
    </div>
    <div id="ball-container">
        <div id="ball-sprite"></div>
    </div>
</div>

<div id="ui-layer">
    <div id="toast">Excellent!</div>

    <!-- Gameplay UI -->
    <div id="gameplay-ui">
        <div id="btn-berry" class="ui-btn" onclick="UI.open('berry')">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/razz-berry.png" width="36">
        </div>
        <div id="btn-ball" class="ui-btn" onclick="UI.open('ball')">
            <img id="current-ball-icon" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" width="36">
        </div>
    </div>

    <!-- Menus -->
    <div id="menu-drawer" class="drawer">
        <h3 id="drawer-title" style="text-align:center; color:#555; margin-top:0;">ITEMS</h3>
        <div id="drawer-list" style="max-height:60vh; overflow-y:auto;"></div>
        <button onclick="UI.close()" style="width:100%; padding:15px; margin-top:10px; border:none; background:#eee; font-weight:bold; border-radius:10px;">Close</button>
    </div>

    <!-- Result Screen -->
    <div id="result-overlay">
        <div id="result-header">Gotcha!</div>
        <img id="res-poke-img" src="" width="140" style="margin-bottom:15px;">
        <div id="res-poke-name" style="font-weight:bold; color:#555; font-size: 18px; margin-bottom:10px;">Pikachu</div>
        <div class="result-stats-box">
            <div class="stat-row">
                <span>Pokémon Caught</span>
                <span class="stat-val">100 XP</span>
            </div>
            <div id="bonus-list"></div>
            <div class="stat-row" style="margin-top:15px; font-size:18px; border-top:1px solid #ddd; padding-top:10px;">
                <span>TOTAL</span>
                <span class="stat-val" id="total-xp-val" style="color:#4CAF50">100 XP</span>
            </div>
            <div class="resource-row">
                <div class="res-item" style="color:#E91E63">
                    <span>CANDY</span>
                    <span class="res-val" id="res-candy">+3</span>
                </div>
                <div class="res-item" style="color:#9C27B0">
                    <span>STARDUST</span>
                    <span class="res-val" id="res-dust">+100</span>
                </div>
            </div>
        </div>
        
        <div class="action-row">
            <button id="btn-storage" class="btn-action" onclick="UI.openStorage()">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" width="24">
                Pokémon
            </button>
            <button id="btn-next" class="btn-action" onclick="Game.nextPokemon()">
                Next ➔
            </button>
        </div>
    </div>

    <!-- Storage Screen -->
    <div id="storage-screen">
        <div id="storage-header">
            <span>Pokemon Storage</span>
            <button onclick="UI.closeStorage()" style="border:none; background:none; font-size:24px; color:#555; padding:0 10px;">✕</button>
        </div>
        <div id="storage-grid">
            <!-- Cards go here -->
        </div>
    </div>
</div>

<script>
    /* --- ASSETS & DATA --- */
    const ASSETS = {
        poke: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/",
        item: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/"
    };

    const DB = {
        balls: {
            'Poke Ball': { img:'poke-ball.png', qty:50, rate: 1.0 },
            'Great Ball': { img:'great-ball.png', qty:30, rate: 1.5 },
            'Ultra Ball': { img:'ultra-ball.png', qty:15, rate: 2.0 },
            'Master Ball': { img:'master-ball.png', qty:1, rate: 100.0 }
        },
        berries: {
            'Razz Berry': { img:'razz-berry.png', qty:10, mod: 1.5 },
            'Nanab Berry': { img:'nanab-berry.png', qty:10, mod: 1.0 }, 
            'Pinap Berry': { img:'pinap-berry.png', qty:10, mod: 1.0 }
        },
        mons: [
            {id:25, n:'Pikachu'}, {id:1, n:'Bulbasaur'}, {id:4, n:'Charmander'},
            {id:7, n:'Squirtle'}, {id:133, n:'Eevee'}, {id:143, n:'Snorlax'},
            {id:150, n:'Mewtwo'}, {id:94, n:'Gengar'}, {id:6, n:'Charizard'}
        ],
        // LOAD STORAGE FROM LOCALSTORAGE
        storage: JSON.parse(localStorage.getItem('poke_storage')) || []
    };

    /* --- GAME ENGINE --- */
    const Game = {
        state: {
            mode: 'idle', 
            ball: 'Poke Ball',
            berry: null,
            spin: 0,
            mon: null,
            pos: {x:0, y:0, z:0},
            vel: {x:0, y:0, z:0},
            rot: 0,
            throwGrade: null, 
            isCurve: false,
            shakeTarget: 0,
            transitioning: false 
        },

        init: () => {
            Game.spawn();
            
            const stage = document.body;
            stage.addEventListener('touchstart', Input.start, {passive: false});
            stage.addEventListener('touchmove', Input.move, {passive: false});
            stage.addEventListener('touchend', Input.end, {passive: false});
            stage.addEventListener('mousedown', Input.start);
            window.addEventListener('mousemove', Input.move);
            window.addEventListener('mouseup', Input.end);

            requestAnimationFrame(Game.loop);
        },

        spawn: () => {
            Game.state.transitioning = false;
            const m = DB.mons[Math.floor(Math.random()*DB.mons.length)];
            const cp = Math.floor(Math.random()*2500)+100;
            Game.state.mon = m;
            Game.state.mon.cp = cp;
            Game.state.berry = null;

            document.getElementById('pokemon-sprite').src = ASSETS.poke + m.id + '.png';
            document.getElementById('pokemon-sprite').style.transform = 'scale(1)';
            document.getElementById('pokemon-sprite').style.opacity = 1;
            document.getElementById('cp-tag').innerText = `${m.n} CP ${cp}`;
            document.getElementById('active-berry').style.display = 'none';
            document.getElementById('ring-container').style.display = 'flex';
            document.getElementById('gameplay-ui').style.display = 'block'; 
            
            const colors = ['#FF0000', '#FF9800', '#4CAF50'];
            document.getElementById('ring-target').style.borderColor = colors[Math.floor(Math.random()*3)];

            Game.resetBall();
        },

        resetBall: () => {
            Game.state.mode = 'idle';
            Game.state.spin = 0;
            Game.state.rot = 0;
            Game.state.throwGrade = null;
            Game.state.isCurve = false;

            const b = document.getElementById('ball-container');
            const g = document.getElementById('ball-sprite');
            
            b.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            b.style.left = '50%';
            b.style.top = 'auto';
            b.style.bottom = '10%';
            b.style.transform = 'translate3d(-50%, 0, 0) scale(1)';
            b.style.display = 'block';
            g.style.transform = 'rotate(0deg)';
        },

        loop: () => {
            if (Game.state.mode === 'hold') {
                if (Math.abs(Game.state.spin) > 0.5) {
                    Game.state.rot += Game.state.spin * 15;
                    document.getElementById('ball-sprite').style.transform = `rotate(${Game.state.rot}deg)`;
                    if(Math.abs(Game.state.spin) > 2 && Math.random() > 0.6) FX.sparkle(Game.state.pos.x, Game.state.pos.y);
                }
                Game.state.spin *= 0.9;
            }
            else if (Game.state.mode === 'fly') {
                const s = Game.state;
                s.pos.x += s.vel.x;
                s.pos.y += s.vel.y;
                s.pos.z += s.vel.z;

                s.vel.y += 0.85; 
                s.vel.z *= 0.98;
                s.vel.x += s.spin * 0.45;

                s.rot += s.spin * 20 + 5; 
                
                const perspective = 900;
                const scale = perspective / (perspective + s.pos.z);
                
                const b = document.getElementById('ball-container');
                const g = document.getElementById('ball-sprite');
                
                b.style.left = s.pos.x + 'px';
                b.style.top = s.pos.y + 'px';
                b.style.transform = `translate3d(-50%, -50%, 0) scale(${scale})`;
                g.style.transform = `rotate(${s.rot}deg)`;

                if (s.pos.z > 250 && s.pos.z < 380) {
                    const rect = document.getElementById('pokemon-container').getBoundingClientRect();
                    if (s.pos.x > rect.left+20 && s.pos.x < rect.right-20 && s.pos.y > rect.top+20 && s.pos.y < rect.bottom-20) {
                        Game.hit();
                    }
                }
                
                if (s.pos.z > 450 || s.pos.y > window.innerHeight) Game.miss();
            }
            requestAnimationFrame(Game.loop);
        },

        hit: () => {
            Game.state.mode = 'catch';
            
            const outer = document.getElementById('ring-outer').offsetWidth;
            const target = document.getElementById('ring-target').offsetWidth;
            const ratio = target/outer;
            
            let msg="Nice!", col="white", gradeBonus = 1.1;
            if(ratio < 0.25) { msg="Excellent!"; col="#FFD700"; Game.state.throwGrade="Excellent"; gradeBonus = 1.8; }
            else if(ratio < 0.55) { msg="Great!"; col="red"; Game.state.throwGrade="Great"; gradeBonus = 1.4; }
            else if(ratio > 0.95) { msg=""; Game.state.throwGrade=null; gradeBonus = 1.0; }
            else { Game.state.throwGrade="Nice"; gradeBonus = 1.1; }

            if(msg) UI.toast(msg, col);

            let baseChance = 0.40;
            const ballRate = DB.balls[Game.state.ball].rate;
            const berryMod = Game.state.berry ? DB.berries[Game.state.berry].mod : 1.0;
            const curveMod = Game.state.isCurve ? 1.2 : 1.0;
            
            let finalChance = baseChance * ballRate * berryMod * gradeBonus * curveMod;
            if (Game.state.ball === 'Master Ball') finalChance = 100;
            
            if (Math.random() < finalChance) Game.state.shakeTarget = 3;
            else Game.state.shakeTarget = Math.floor(Math.random() * 3);

            document.getElementById('ring-container').style.display = 'none';
            const b = document.getElementById('ball-container');
            const p = document.getElementById('pokemon-container').getBoundingClientRect();
            
            b.style.transition = 'all 0.1s linear';
            b.style.left = (p.left + p.width/2) + 'px';
            b.style.top = (p.top + p.height/2) + 'px';
            b.style.transform = `translate(-50%, -50%) scale(0.7)`;
            
            const sprite = document.getElementById('pokemon-sprite');
            sprite.style.transition = 'all 0.4s ease-in';
            sprite.style.transform = 'scale(0) rotate(270deg)';
            sprite.style.opacity = 0;

            setTimeout(() => {
                b.style.transition = 'top 0.4s ease-out';
                b.style.top = (p.bottom - 40) + 'px';
                setTimeout(() => Game.playShake(0), 400);
            }, 400);
        },

        playShake: (count) => {
            const b = document.getElementById('ball-sprite');
            
            if(count >= 3) {
                // SUCCESS
                document.getElementById('ball-container').classList.add('catch-flash');
                // SAVE POKEMON
                DB.storage.unshift({
                    id: Game.state.mon.id,
                    name: Game.state.mon.n,
                    cp: Game.state.mon.cp,
                    date: new Date().toLocaleDateString()
                });
                localStorage.setItem('poke_storage', JSON.stringify(DB.storage));

                setTimeout(() => {
                    document.getElementById('ball-container').classList.remove('catch-flash');
                    Game.showResults();
                }, 1000);
                return;
            }
            
            if(count < Game.state.shakeTarget) {
                b.style.animation = 'none';
                b.offsetHeight; 
                b.parentElement.classList.add('shake');
                setTimeout(() => {
                    b.parentElement.classList.remove('shake');
                    Game.playShake(count + 1);
                }, 1000);
            } else {
                UI.toast("Broke free!", "white");
                document.getElementById('ball-container').style.display = 'none';
                const sprite = document.getElementById('pokemon-sprite');
                sprite.style.transform = 'scale(1)';
                sprite.style.opacity = 1;
                document.getElementById('ring-container').style.display = 'flex';
                setTimeout(Game.resetBall, 1000);
            }
        },

        showResults: () => {
            const s = Game.state;
            const res = document.getElementById('result-overlay');
            const list = document.getElementById('bonus-list');
            
            document.getElementById('res-poke-img').src = ASSETS.poke + s.mon.id + '.png';
            document.getElementById('res-poke-name').innerText = s.mon.n + " (CP " + s.mon.cp + ")";
            
            let totalXP = 100;
            list.innerHTML = '';
            
            if (s.throwGrade) {
                let bonus = s.throwGrade === 'Excellent' ? 1000 : (s.throwGrade === 'Great' ? 500 : 100);
                totalXP += bonus;
                list.innerHTML += `<div class="stat-row bonus-row"><span>${s.throwGrade} Throw</span><span>+${bonus} XP</span></div>`;
            }
            if (s.isCurve) {
                totalXP += 20;
                list.innerHTML += `<div class="stat-row bonus-row"><span>Curveball</span><span>+20 XP</span></div>`;
            }

            document.getElementById('total-xp-val').innerText = totalXP + " XP";
            let candy = s.berry === 'Pinap Berry' ? 6 : 3;
            document.getElementById('res-candy').innerText = "+" + candy;

            document.getElementById('gameplay-ui').style.display = 'none';
            res.style.display = 'flex';
            setTimeout(() => res.classList.add('visible'), 10);
        },

        nextPokemon: () => {
            if (Game.state.transitioning) return;
            Game.state.transitioning = true;
            const res = document.getElementById('result-overlay');
            res.classList.remove('visible');
            setTimeout(() => {
                res.style.display = 'none';
                Game.spawn();
            }, 300);
        },

        miss: () => {
            Game.state.mode = 'idle';
            setTimeout(Game.resetBall, 600);
        }
    };

    /* --- INPUT SYSTEM --- */
    const Input = {
        active: false,
        hist: [],

        start: (e) => {
            if (Game.state.mode !== 'idle') return;
            const p = e.touches ? e.touches[0] : e;
            const rect = document.getElementById('ball-container').getBoundingClientRect();
            const pad = 120;
            if (p.clientX < rect.left - pad || p.clientX > rect.right + pad || p.clientY < rect.top - pad) return;

            e.preventDefault();
            Input.active = true;
            Game.state.mode = 'hold';
            Input.hist = [];
            
            const b = document.getElementById('ball-container');
            b.style.transition = 'none';
            b.style.transform = `translate3d(-50%, -50%, 0) scale(1.15)`;
            Input.track(p.clientX, p.clientY);
        },

        move: (e) => {
            if (!Input.active) return;
            e.preventDefault();
            const p = e.touches ? e.touches[0] : e;
            Input.track(p.clientX, p.clientY);
        },

        track: (x, y) => {
            const now = Date.now();
            Input.hist.push({x, y, t:now});
            if (Input.hist.length > 8) Input.hist.shift();
            Game.state.pos.x = x;
            Game.state.pos.y = y;
            if (Input.hist.length > 3) {
                const prev = Input.hist[Input.hist.length-2];
                const dx = x - prev.x;
                Game.state.spin = dx * 0.8; 
            }
        },

        end: (e) => {
            if (!Input.active) return;
            Input.active = false;
            const hist = Input.hist;
            if(hist.length < 2) { Game.resetBall(); return; }
            const start = hist[0];
            const end = hist[hist.length-1];
            const dt = end.t - start.t;
            if(Date.now() - end.t > 150) { Game.resetBall(); return; }
            const vx = (end.x - start.x) / dt;
            const vy = (end.y - start.y) / dt;
            if (vy > -0.5) { Game.resetBall(); return; }

            if(DB.balls[Game.state.ball].qty > 0) DB.balls[Game.state.ball].qty--;
            UI.updateIcon();

            Game.state.mode = 'fly';
            Game.state.isCurve = Math.abs(Game.state.spin) > 2;
            const b = document.getElementById('ball-container');
            b.style.transition = 'none';
            Game.state.vel.x = vx * 16;
            Game.state.vel.y = vy * 16;
            Game.state.vel.z = Math.abs(vy) * 26; 
            Game.state.pos.z = 0;
        }
    };

    /* --- FX & UI --- */
    const FX = {
        sparkle: (x, y) => {
            const el = document.createElement('div');
            el.className = 'sparkle';
            const ox = (Math.random()-0.5) * 80;
            const oy = (Math.random()-0.5) * 80;
            el.style.left = (x + ox) + 'px';
            el.style.top = (y + oy) + 'px';
            document.body.appendChild(el);
            requestAnimationFrame(() => {
                el.style.transition = 'all 0.5s ease-out';
                el.style.opacity = 1;
                el.style.transform = 'scale(0)';
                setTimeout(() => el.remove(), 500);
            });
        }
    };

    const UI = {
        toast: (msg, col) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.textShadow = `0 0 5px ${col}, 2px 2px 0 black`;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2000);
        },
        open: (type) => {
            if(Game.state.mode !== 'idle') return;
            const list = document.getElementById('drawer-list');
            list.innerHTML = '';
            document.getElementById('drawer-title').innerText = "SELECT " + type.toUpperCase();
            const data = type === 'ball' ? DB.balls : DB.berries;
            for(let key in data) {
                const item = data[key];
                const row = document.createElement('div');
                row.className = 'drawer-item';
                row.onclick = () => UI.select(type, key);
                row.innerHTML = `<img src="${ASSETS.item + item.img}" width="40" style="margin-right:15px"><div style="flex:1"><b>${key}</b><br><small>x${item.qty}</small></div>`;
                list.appendChild(row);
            }
            document.getElementById('menu-drawer').classList.add('open');
        },
        close: () => document.getElementById('menu-drawer').classList.remove('open'),
        select: (type, key) => {
            const item = type === 'ball' ? DB.balls[key] : DB.berries[key];
            if(item.qty <= 0) return;
            if(type === 'ball') {
                Game.state.ball = key;
                UI.updateIcon();
            } else {
                if(Game.state.berry) return;
                item.qty--;
                Game.state.berry = key;
                document.getElementById('active-berry').src = ASSETS.item + item.img;
                document.getElementById('active-berry').style.display = 'block';
                UI.toast(key + " used!", "#E91E63");
            }
            UI.close();
        },
        updateIcon: () => {
            const img = DB.balls[Game.state.ball].img;
            document.getElementById('current-ball-icon').src = ASSETS.item + img;
            document.getElementById('ball-sprite').style.backgroundImage = `url('${ASSETS.item + img}')`;
        },
        // STORAGE UI
        openStorage: () => {
            const grid = document.getElementById('storage-grid');
            grid.innerHTML = '';
            
            DB.storage.forEach(p => {
                const card = document.createElement('div');
                card.className = 'storage-card';
                card.innerHTML = `
                    <div class="card-cp">CP ${p.cp}</div>
                    <img class="card-img" src="${ASSETS.poke + p.id + '.png'}">
                    <div class="card-name">${p.name}</div>
                    <div class="card-date">${p.date}</div>
                `;
                grid.appendChild(card);
            });
            
            document.getElementById('storage-screen').style.display = 'flex';
        },
        closeStorage: () => {
            document.getElementById('storage-screen').style.display = 'none';
            // Trigger next pokemon automatically
            Game.nextPokemon();
        }
    };

    window.onload = Game.init;
</script>
</body>
</html>